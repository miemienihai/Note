# 3D 玩家角色创建

素材包：https://pan.xunlei.com/s/VMpKwnbUIpmCLtdSOBgI3BzTA1 提取码：3z5t

## 1. 项目初始化

- 新建 3D 项目
- 导入素材包

## 2. 导入 3D 模型并配置

- 导入 3D 人物模型
- 创建预制件
- 设置动画
- 添加碰撞体

## 3. 3D 动画

### 3.1 和 2D 动画的区别

- 3D 更加复杂，2D 一般只用来表示动作，而 3D 动画本身，除了动作，还会表示位移
- 3D 一般都需要进行角色的骨骼绑定、素材、材质等设置

### 3.2 Animator 属性面板

- Apply Root Motion  
   选择从动画本身还是从脚本控制角色的位置和旋转。
- Update Mode  
  此选项允许您选择 Animator 何时更新以及应使用哪个时间标度。
  - Normal Animator： 与 Update 调用同步更新，Animator 的速度与当前时间标度匹配。如果时间标度变慢，动画将通过减速来匹配。(Update 一般用来获取用户的输入和与用户之间的交互写在这个里面)
  - Animate Physics Animator： 与 FixedUpdate 调用同步更新（即，与物理系统步调一致）。如果要对具有物理交互的对象（例如可四处推动刚体对象的角色）的运动进行动画化，应使用此模式。(FixedUpdate 用来让物体发生移动的操作写在这个里面)
  - Unscaled Time： Animator 与 Update 调用同步更新，但是 Animator 的速度忽略当前时间标度而不顾一切以 100% 速度进行动画化。此选项可用于以正常速度对 GUI 系统进行动画化，同时将修改的时间标度用于特效或暂停游戏。

### 3.3 难点：根运动 root Motion

先简单理解为，在 Animator 组件上启用了 Apply Root Motion，动画中的任何移动会体现在外部场景世界坐标中。不启用，动画中的移动会只保留在动画中

- Animator 的 Update Mode

> 参考资料：
+ 动画组件中有一个Back into pose 根据他的名字返回到姿势中,是想要表达你的动画发生移动是否应用到实际场景中,我们首先来看这个“Bake into Pose".在untiy中将动画中的变换分成两种，Body Transform和Root Transform,勾线Bake into Pose 就是 Root Transform
+ Apply Root Motion的第二个作用是在动画结束后，将Body Transform中的变化应用到模型
+ 如果开启Apply Root Motion,Body Transform 模式下肢体的位置不会应用到实际场景中,但是动画最终会唯一到一个地方,开启,就会将位置应用到实际场景中,不开,就会在动画结束闪现会原来地点
+ Root Transform最大优势在于,他会在开启Apply Root Motion,将每个人物部件的position 时时变化,这也是他的目的所在,Body Transform动画模式,所以它并不关注每个组件的位置,他只是想要播放动画,所以时时更新每个部件position 没有意义,如果不勾选Apply Root Motion将会让人物原地奔跑,Apply Root Motion没有给他开权限.




> - [根运动 - 官方手册](https://docs.unity3d.com/cn/current/Manual/RootMotion.html)
> - [Root Motion 深度解析[Unity]](https://blog.csdn.net/cubesky/article/details/39478207)
> - [Unity 开发：RootMotion 详解](https://zhuanlan.zhihu.com/p/428251577)

## 3.2 添加刚体组件以后人物会原地起飞(bug)
+ 这个和上面就存在紧密联系,刚体可以移动,而动画也有移动,两者冲突就会让人物原地起飞
+ 解决方法: 
   1. 移动选项应该是FixeUpdate,所以你要在Animator中选择
   2. 限制人物刚体组件的Z轴位置移动,同时选址x z轴旋转 这跟2D中的原理一样,限制不合理的运动.


## 4. 为角色添加脚本(包括移动和旋转)
+ 我们照顾到动画本身就有移动,所以我们将刚体的变化写在了OnAnimatorMove中
+ 移动本身我们用vector3来代表 ,同时动画也有移动, 我们用输入的vetor3 来代表移动方向,动画作为辅助
+ 旋转 我们需要用Vector3来创建一个我们当前看向的方向,四元函数来实现旋转.

```C#
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class LenmonController : MonoBehaviour
{
    /// <summary>
    /// 获取输入 ,然后设置动画, 最后 在动画组件中更新位置.
    /// </summary>
    // Start is called before the first frame update
    Vector3 M_Movement;
    Vector3 _disredForward;
    Animator A_animator;
    Rigidbody R_rigidbody;
    float _herizongtal;
    float _vertical;
    Quaternion M_rotation = Quaternion.identity;
    public float _turnSpeed = 20.0f;

    void Start()
    {
        R_rigidbody = GetComponent<Rigidbody>();
        A_animator = GetComponent<Animator>();
    }

    // Update is called once per frame
    void Update()
    {
        // 关于3D 物体运动是采用Vector3来表示的.
        _herizongtal = Input.GetAxis("Horizontal");
        _vertical = Input.GetAxis("Vertical");
        bool _isWalking = (!Mathf.Approximately(_herizongtal, 0.0f) || !Mathf.Approximately(_vertical, 0.0f));

        // 用于移动
        A_animator.SetBool("IsWalking", _isWalking);
        M_Movement.Set(_herizongtal, 0.0f, _vertical);
        M_Movement.Normalize();

        //旋转 首先构建 移动以后 看向的方向 ,通过 移动距离来实现 , 通过他构建四元函数 代表旋转的方向 ,我们利用四元来构建旋转.
        _disredForward = Vector3.RotateTowards(transform.forward, M_Movement, _turnSpeed * Time.deltaTime, 0f);
        M_rotation = Quaternion.LookRotation(_disredForward);
    }
    //这个函数 跟我们前面知识紧密关联,他是在我们勾选bake into pose时才会调用,用于处理动画移动以修改根运动的回调,按照这样的描述,就更bake into pose 紧密相关
    // 该回调在处理完状态机和动画后 （但在 OnAnimatorIK 之前）的每个帧中调用,重点每个帧中去调用,也就是动画本身postion移动,都会调用它.
    // 为什么移动写在这里,动画本身有个移动,然后我们输入也有一个移动,一起在同一个地方调用,有利用规范.
    private void OnAnimatorMove()
    {
        // 这里我们窥探 物体动画和输入移动的根本, 利用键鼠移动的向量为方向 动画移动为辅助 deltaPosition 动画移动距离 magnitude 向量长度计算.
        R_rigidbody.MovePosition(R_rigidbody.position + M_Movement * A_animator.deltaPosition.magnitude);
        R_rigidbody.MoveRotation(M_rotation);


    }



}

```

<br>
<hr>
<br>

配套视频教程：
[https://space.bilibili.com/43644141/channel/seriesdetail?sid=299912](https://space.bilibili.com/43644141/channel/seriesdetail?sid=299912)

文章也同时同步微信公众号，喜欢使用手机观看文章的可以关注

![](../../imgs/微信公众号二维码.jpg)
